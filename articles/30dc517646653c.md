---
title: "NextAuth ä½¿ã£ã¦ã¿ãŸ"
emoji: "ğŸ§"
type: "tech"
topics:
  - "nextjs"
  - "react"
  - "typescript"
  - "nextauth"
published: true
published_at: "2022-06-20 01:49"
---



åˆã‚ã¦NextAuthã‚’ä½¿ã£ã¦å°‘ã—è©°ã¾ã£ãŸã¨ã“ã‚ã‚‚ã‚ã£ãŸã®ã§è‡ªåˆ†ç”¨ã«ãƒ¡ãƒ¢
ä»Šå›ã¯Google Providerã‚’ä½¿ç”¨ã—ã¦ã¾ã™

## ç›®çš„
NextAuthã‚’ä½¿ã£ã¦Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹

## Next.jsã®è¨­å®š

Next.js TypeScriptã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹

```
yarn create next-app --typescript
```

NextAuthã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
yarn add next-auth
```


pages/api/auth/[...nextauth].ts ã®ä½œæˆ
```ts:pages/api/auth/[...nextauth].ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

export default NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID ?? '',
      clientSecret: process.env.GOOGLE_CLIENT_SECRET ?? '',
    }),
  ],
  callbacks: {
    //jwtãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹
    async jwt({ token, account }) {
      if (account) {
        token.accessToken = account.access_token;
      }
      return token;
    },
    //ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹
    async session({ session, token, user }) {
      session.accessToken = token.accessToken;
      return session;
    },
  },
});
```


```tsx:index.tsx
import type { NextPage } from 'next';
import { useSession, signIn, signOut } from 'next-auth/react';

const Home: NextPage = () => {
  const { data: session } = useSession();

  if (session && session.user) {
    return (
      <>
        Signed in as {session.user.email} <br />
        <button onClick={() => signOut()}>Sign out</button>
      </>
    );
  }
  return (
    <>
      Not signed in <br />
      <button onClick={() => signIn()}>Sign in</button>
    </>
  );
};

export default Home;
```


```tsx:_app.tsx
import type { AppProps } from 'next/app';
import { SessionProvider } from 'next-auth/react';

function MyApp({ Component, pageProps: { session, ...pageProps } }: AppProps) {
  return (
    <SessionProvider session={session}>
      <Component {...pageProps} />
    </SessionProvider>
  );
}

export default MyApp;
```



ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«.env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã‚‚å‘¼ã³å‡ºã—ãŸã„ãªã‚‰å¤‰æ•°åã®å‰ã«`NEXT_PUBLIC_` ãŒå¿…è¦
```jsx:.env.local
GOOGLE_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
GOOGLE_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxx
```

## OAuthã®è¨­å®š
OAtuthåŒæ„ç”»é¢ã®è¨­å®šã™ã‚‹
https://console.cloud.google.com/apis/credentials

ä¸‹è¨˜ãŒã‚ã‹ã‚Šã‚„ã™ã„(è£œè¶³ã¨ã—ã¦Google WorkSpaceãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„å ´åˆUse Typeã¯å¤–éƒ¨ã‚’é¸æŠ)
https://support.google.com/workspacemigrate/answer/9222992?hl=ja


OAtuthåŒæ„ç”»é¢ã®è¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰èªè¨¼æƒ…å ±ã«ç§»å‹•ã—ã¦OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ä½œæˆã™ã‚‹

![https://i.gyazo.com/9171ccbd5e9b9ee1ff5047259d8b7668.png](https://i.gyazo.com/9171ccbd5e9b9ee1ff5047259d8b7668.png)


ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã¯ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®š
ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã«`http://localhost:3000/api/auth/callback/google`ã‚’è¨­å®š


![https://i.gyazo.com/9dfe500df0cfcd0941e118ea567c4d5e.png](https://i.gyazo.com/9dfe500df0cfcd0941e118ea567c4d5e.png)

ä½œæˆã™ã‚‹ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã‚³ãƒ”ãƒ¼ã—ã¦
Next.jså´ã§ä½œæˆã—ãŸ.env.localã«è²¼ã‚Šä»˜ã‘ã‚‹


```tsx:.env.local
GOOGLE_CLIENT_ID=ã‚³ãƒ”ãƒ¼ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
GOOGLE_CLIENT_SECRET=ã‚³ãƒ”ãƒ¼ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
```

yarn devã§ã‚µãƒ¼ãƒèµ·å‹•

ãƒ­ã‚°ã‚¤ãƒ³å‰

[![Image from Gyazo](https://i.gyazo.com/0e3ad236cdf0c734bdc9dfcc8bd1884e.jpg)](https://gyazo.com/0e3ad236cdf0c734bdc9dfcc8bd1884e)

ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå¾Œ

![https://i.gyazo.com/87a43acd1ae775bd003a35a5182bbf24.png](https://i.gyazo.com/87a43acd1ae775bd003a35a5182bbf24.png)

ãƒ­ã‚°ã‚¤ãƒ³å¾Œ

![https://i.gyazo.com/ba55f4454212845b0f117501888894c4.png](https://i.gyazo.com/ba55f4454212845b0f117501888894c4.png)

ã¡ã¿ãªã«signInã®å¼•æ•°ã«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã¨ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå¾Œã®ç”»é¢ã‚’
ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹ã‚ˆã†ã§ã™

```tsx:index.tsx
import type { NextPage } from 'next';
import { useSession, signIn, signOut } from 'next-auth/react';

const Home: NextPage = () => {
  const { data: session } = useSession();

  if (session && session.user) {
    return (
      <>
        Signed in as {session.user.email} <br />
        <button onClick={() => signOut()}>Sign out</button>
      </>
    );
  }
  return (
    <>
      Not signed in <br />
      {/* å¤‰æ›´ */}
      <button onClick={() => signIn('google')}>Sign in</button>
    </>
  );
};

export default Home;
```

## æ‰€æ„Ÿ

ãƒ¡ãƒ¼ãƒ«èªè¨¼ä½¿ç”¨ã—ãªã„ãªã‚‰firebase authã‚ˆã‚Šã‚‚ã“ã£ã¡ã‚’ä½¿ã£ãŸã»ã†ãŒæ¥½ã‹ã‚‚
å¤§ä½“ã®ã“ã¨ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã‚ã°è§£æ±ºã—ãã† 
https://next-auth.js.org/

ä»Šå›ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
https://github.com/happy663/next-auth-sample